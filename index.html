<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#e8f4f8">
  <meta name="description" content="FloatNote - Capture moments, add visual notes">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRmxvYXROb3RlIiwic2hvcnRfbmFtZSI6IkZsb2F0Tm90ZSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZThmNGY4IiwidGhlbWVfY29sb3IiOiIjZThmNGY4IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTkyIDE5Mic%2BJTNDcmVjdCBmaWxsPSclMjNlOGY0ZjgnIHdpZHRoPScxOTInIGhlaWdodD0nMTkyJy8%2BJTNDdGV4dCB4PScxMCcgeT0nMTIwJyBmb250LXNpemU9JzEwMCcgZmlsbD0nJTIzNGE5MGE0JyUzRfCfk7glM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <title>FloatNote</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --zen-bg: linear-gradient(135deg, #e8f4f8 0%, #f0e8f4 100%);
      --zen-primary: #4a90a4;
      --zen-secondary: #a47ba4;
      --zen-accent: #7ba4a4;
      --zen-light: #ffffff;
      --zen-shadow: rgba(74, 144, 164, 0.15);
      --zen-text: #2c3e50;
      --zen-text-light: #7f8c8d;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--zen-bg);
      color: var(--zen-text);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Breathing animation for text */
    @keyframes breathe {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.02); }
    }

    /* Header */
    .header {
      padding: 1.5rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px var(--zen-shadow);
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 300;
      color: var(--zen-primary);
      animation: breathe 4s ease-in-out infinite;
      letter-spacing: 2px;
    }

    .header p {
      font-size: 0.9rem;
      color: var(--zen-text-light);
      margin-top: 0.3rem;
      font-weight: 300;
    }

    /* Floating Button */
    .float-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--zen-primary), var(--zen-accent));
      box-shadow: 0 8px 30px var(--zen-shadow);
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .float-btn:active {
      transform: scale(0.95);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .float-btn {
      animation: float 3s ease-in-out infinite;
    }

    /* Gallery */
    .gallery {
      padding: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px var(--zen-shadow);
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .gallery-item:active {
      transform: scale(0.97);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-item .note-count {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(74, 144, 164, 0.9);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      backdrop-filter: blur(5px);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      animation: breathe 4s ease-in-out infinite;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-state h2 {
      font-size: 1.5rem;
      font-weight: 300;
      color: var(--zen-text);
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      color: var(--zen-text-light);
      font-weight: 300;
    }

    /* Modal Overlay */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--zen-light);
    }

    /* Canvas Container */
    .canvas-container {
      position: relative;
      flex: 1;
      overflow: hidden;
      background: #f8f9fa;
    }

    .canvas-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #photoCanvas, #drawCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100%;
      max-height: 100%;
    }

    /* Sticky Notes */
    .sticky-note {
      position: absolute;
      min-width: 120px;
      padding: 12px;
      background: var(--note-color, #fff9c4);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      cursor: move;
      transition: transform 0.2s ease;
      z-index: 10;
      user-select: none;
    }

    .sticky-note:active {
      transform: scale(1.05) rotate(2deg);
      z-index: 20;
    }

    .sticky-note textarea {
      width: 100%;
      border: none;
      background: transparent;
      resize: none;
      font-family: inherit;
      font-size: 13px;
      color: var(--zen-text);
      outline: none;
    }

    .sticky-note .delete-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--zen-secondary);
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .sticky-note:hover .delete-btn {
      opacity: 1;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(74, 144, 164, 0.1);
      overflow-x: auto;
      flex-wrap: nowrap;
    }

    .toolbar button {
      padding: 10px 16px;
      border: none;
      border-radius: 20px;
      background: var(--zen-primary);
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .toolbar button:active {
      transform: scale(0.95);
    }

    .toolbar button.active {
      background: var(--zen-secondary);
    }

    .toolbar input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
    }

    .toolbar input[type="range"] {
      width: 80px;
    }

    /* Color Palette */
    .color-palette {
      display: flex;
      gap: 8px;
      padding: 8px;
    }

    .color-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid white;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s;
    }

    .color-btn:active {
      transform: scale(0.9);
    }

    /* Camera Input */
    #cameraInput {
      display: none;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(74, 144, 164, 0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      z-index: 3000;
      opacity: 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Loading */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      z-index: 4000;
      animation: breathe 2s ease-in-out infinite;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }
      
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        padding: 1rem;
      }
      
      .float-btn {
        width: 60px;
        height: 60px;
        bottom: 1.5rem;
        right: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üå∏ FloatNote</h1>
    <p>Floating thoughts...</p>
  </div>

  <div class="gallery" id="gallery"></div>

  <div class="empty-state" id="emptyState">
    <div class="icon">üì∏</div>
    <h2>Capture your first moment</h2>
    <p>Tap the floating button to begin</p>
  </div>

  <button class="float-btn" id="floatBtn">üì∑</button>
  <input type="file" id="cameraInput" accept="image/*" capture="environment">

  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="canvas-container">
        <div class="canvas-wrapper" id="canvasWrapper">
          <canvas id="photoCanvas"></canvas>
          <canvas id="drawCanvas"></canvas>
        </div>
      </div>
      <div class="toolbar">
        <button id="addNoteBtn">üìå Note</button>
        <button id="drawBtn">‚úèÔ∏è Draw</button>
        <button id="eraserBtn">üßπ Erase</button>
        <input type="color" id="colorPicker" value="#000000">
        <input type="range" id="brushSize" min="1" max="20" value="3">
        <button id="clearDrawBtn">Clear</button>
        <button id="saveBtn">üíæ Save</button>
        <button id="closeBtn">‚úï</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // State management
    const state = {
      currentPhoto: null,
      currentPhotoId: null,
      notes: [],
      isDrawing: false,
      drawMode: false,
      eraserMode: false,
      lastX: 0,
      lastY: 0,
      drawings: []
    };

    // Note colors
    const noteColors = ['#fff9c4', '#f8bbd0', '#c5e1a5', '#b3e5fc', '#ffccbc', '#e1bee7'];

    // Elements
    const floatBtn = document.getElementById('floatBtn');
    const cameraInput = document.getElementById('cameraInput');
    const modal = document.getElementById('modal');
    const gallery = document.getElementById('gallery');
    const emptyState = document.getElementById('emptyState');
    const photoCanvas = document.getElementById('photoCanvas');
    const drawCanvas = document.getElementById('drawCanvas');
    const canvasWrapper = document.getElementById('canvasWrapper');
    const toast = document.getElementById('toast');

    // Buttons
    const addNoteBtn = document.getElementById('addNoteBtn');
    const drawBtn = document.getElementById('drawBtn');
    const eraserBtn = document.getElementById('eraserBtn');
    const clearDrawBtn = document.getElementById('clearDrawBtn');
    const saveBtn = document.getElementById('saveBtn');
    const closeBtn = document.getElementById('closeBtn');
    const colorPicker = document.getElementById('colorPicker');
    const brushSize = document.getElementById('brushSize');

    const photoCtx = photoCanvas.getContext('2d');
    const drawCtx = drawCanvas.getContext('2d');

    // Initialize
    loadGallery();

    // Event Listeners
    floatBtn.addEventListener('click', () => {
      vibrate(10);
      cameraInput.click();
    });

    cameraInput.addEventListener('change', handleImageUpload);
    addNoteBtn.addEventListener('click', addStickyNote);
    drawBtn.addEventListener('click', toggleDrawMode);
    eraserBtn.addEventListener('click', toggleEraserMode);
    clearDrawBtn.addEventListener('click', clearDrawing);
    saveBtn.addEventListener('click', saveCurrentPhoto);
    closeBtn.addEventListener('click', closeModal);

    // Drawing events
    drawCanvas.addEventListener('mousedown', startDrawing);
    drawCanvas.addEventListener('mousemove', draw);
    drawCanvas.addEventListener('mouseup', stopDrawing);
    drawCanvas.addEventListener('mouseout', stopDrawing);

    drawCanvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = drawCanvas.getBoundingClientRect();
      state.lastX = touch.clientX - rect.left;
      state.lastY = touch.clientY - rect.top;
      state.isDrawing = true;
    });

    drawCanvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!state.isDrawing || !state.drawMode) return;
      const touch = e.touches[0];
      const rect = drawCanvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      drawLine(state.lastX, state.lastY, x, y);
      state.lastX = x;
      state.lastY = y;
    });

    drawCanvas.addEventListener('touchend', () => {
      state.isDrawing = false;
    });

    // Functions
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          state.currentPhoto = img;
          state.currentPhotoId = Date.now().toString();
          state.notes = [];
          state.drawings = [];
          openModal(img);
          showToast('Pinned! ‚ú®');
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
      cameraInput.value = '';
    }

    function openModal(img) {
      // Set canvas sizes
      const maxWidth = window.innerWidth;
      const maxHeight = window.innerHeight - 100;
      let width = img.width;
      let height = img.height;

      const ratio = Math.min(maxWidth / width, maxHeight / height);
      width *= ratio;
      height *= ratio;

      photoCanvas.width = drawCanvas.width = width;
      photoCanvas.height = drawCanvas.height = height;

      // Draw image
      photoCtx.drawImage(img, 0, 0, width, height);

      // Clear draw canvas
      drawCtx.clearRect(0, 0, width, height);

      modal.classList.add('active');
    }

    function addStickyNote() {
      vibrate(10);
      const color = noteColors[Math.floor(Math.random() * noteColors.length)];
      const note = {
        id: Date.now().toString(),
        text: '',
        x: 50,
        y: 50,
        color: color
      };

      state.notes.push(note);
      renderNote(note);
      showToast('Note added üìù');
    }

    function renderNote(note) {
      const noteEl = document.createElement('div');
      noteEl.className = 'sticky-note';
      noteEl.style.left = note.x + 'px';
      noteEl.style.top = note.y + 'px';
      noteEl.style.setProperty('--note-color', note.color);
      noteEl.dataset.id = note.id;

      const textarea = document.createElement('textarea');
      textarea.value = note.text;
      textarea.rows = 3;
      textarea.placeholder = 'Type here...';
      textarea.addEventListener('input', (e) => {
        note.text = e.target.value;
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '√ó';
      deleteBtn.addEventListener('click', () => {
        vibrate(5);
        state.notes = state.notes.filter(n => n.id !== note.id);
        noteEl.remove();
      });

      noteEl.appendChild(textarea);
      noteEl.appendChild(deleteBtn);
      canvasWrapper.appendChild(noteEl);

      makeDraggable(noteEl, note);
    }

    function makeDraggable(el, note) {
      let isDragging = false;
      let startX, startY, initialX, initialY;

      const onStart = (e) => {
        isDragging = true;
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        const rect = el.getBoundingClientRect();
        startX = clientX - rect.left;
        startY = clientY - rect.top;
        initialX = rect.left - canvasWrapper.getBoundingClientRect().left;
        initialY = rect.top - canvasWrapper.getBoundingClientRect().top;
        el.style.zIndex = 20;
      };

      const onMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        const wrapperRect = canvasWrapper.getBoundingClientRect();
        const x = clientX - wrapperRect.left - startX;
        const y = clientY - wrapperRect.top - startY;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        note.x = x;
        note.y = y;
      };

      const onEnd = () => {
        isDragging = false;
        el.style.zIndex = 10;
      };

      el.addEventListener('mousedown', onStart);
      el.addEventListener('touchstart', onStart);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('mouseup', onEnd);
      document.addEventListener('touchend', onEnd);
    }

    function toggleDrawMode() {
      state.drawMode = !state.drawMode;
      state.eraserMode = false;
      drawBtn.classList.toggle('active');
      eraserBtn.classList.remove('active');
      drawCanvas.style.cursor = state.drawMode ? 'crosshair' : 'default';
      drawCanvas.style.pointerEvents = state.drawMode ? 'auto' : 'none';
      vibrate(10);
    }

    function toggleEraserMode() {
      state.eraserMode = !state.eraserMode;
      state.drawMode = state.eraserMode;
      eraserBtn.classList.toggle('active');
      if (state.eraserMode) drawBtn.classList.add('active');
      drawCanvas.style.cursor = state.eraserMode ? 'grab' : (state.drawMode ? 'crosshair' : 'default');
      drawCanvas.style.pointerEvents = state.drawMode ? 'auto' : 'none';
      vibrate(10);
    }

    function startDrawing(e) {
      if (!state.drawMode) return;
      state.isDrawing = true;
      const rect = drawCanvas.getBoundingClientRect();
      state.lastX = e.clientX - rect.left;
      state.lastY = e.clientY - rect.top;
    }

    function draw(e) {
      if (!state.isDrawing || !state.drawMode) return;
      const rect = drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      drawLine(state.lastX, state.lastY, x, y);
      state.lastX = x;
      state.lastY = y;
    }

    function drawLine(x1, y1, x2, y2) {
      drawCtx.beginPath();
      drawCtx.moveTo(x1, y1);
      drawCtx.lineTo(x2, y2);
      drawCtx.strokeStyle = state.eraserMode ? '#ffffff' : colorPicker.value;
      drawCtx.lineWidth = brushSize.value;
      drawCtx.lineCap = 'round';
      drawCtx.stroke();

      state.drawings.push({
        x1, y1, x2, y2,
        color: state.eraserMode ? '#ffffff' : colorPicker.value,
        width: brushSize.value
      });
    }

    function stopDrawing() {
      state.isDrawing = false;
    }

    function clearDrawing() {
      vibrate(10);
      drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
      state.drawings = [];
      showToast('Canvas cleared üßπ');
    }

    function saveCurrentPhoto() {
      vibrate(15);
      
      // Create composite canvas
      const composite = document.createElement('canvas');
      composite.width = photoCanvas.width;
      composite.height = photoCanvas.height;
      const ctx = composite.getContext('2d');
      
      // Draw photo and drawings
      ctx.drawImage(photoCanvas, 0, 0);
      ctx.drawImage(drawCanvas, 0, 0);

      const photoData = {
        id: state.currentPhotoId,
        image: composite.toDataURL('image/jpeg', 0.9),
        notes: state.notes,
        drawings: state.drawings,
        timestamp: Date.now()
      };

      // Save to storage
      const photos = JSON.parse(localStorage.getItem('floatnote_photos') || '[]');
      const existingIndex = photos.findIndex(p => p.id === photoData.id);
      
      if (existingIndex >= 0) {
        photos[existingIndex] = photoData;
      } else {
        photos.unshift(photoData);
      }
      
      localStorage.setItem('floatnote_photos', JSON.stringify(photos));
      
      showToast('Saved! üíæ');
      setTimeout(() => {
        closeModal();
        loadGallery();
      }, 500);
    }

    function closeModal() {
      vibrate(5);
      modal.classList.remove('active');
      state.notes.forEach(note => {
        const el = document.querySelector(`[data-id="${note.id}"]`);
        if (el) el.remove();
      });
      state.notes = [];
      state.drawings = [];
      state.drawMode = false;
      state.eraserMode = false;
      drawBtn.classList.remove('active');
      eraserBtn.classList.remove('active');
    }

    function loadGallery() {
      const photos = JSON.parse(localStorage.getItem('floatnote_photos') || '[]');
      gallery.innerHTML = '';
      
      if (photos.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      photos.forEach(photo => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        
        const img = document.createElement('img');
        img.src = photo.image;
        
        const count = document.createElement('div');
        count.className = 'note-count';
        count.textContent = `${photo.notes.length} üìå`;
        
        item.appendChild(img);
        item.appendChild(count);
        gallery.appendChild(item);
        
        item.addEventListener('click', () => {
          vibrate(10);
          openExistingPhoto(photo);
        });
      });
    }

    function openExistingPhoto(photoData) {
      const img = new Image();
      img.onload = () => {
        state.currentPhoto = img;
        state.currentPhotoId = photoData.id;
        state.notes = [...photoData.notes];
        state.drawings = [...photoData.drawings];
        
        openModal(img);
        
        // Redraw drawings
        photoData.drawings.forEach(d => {
          drawCtx.beginPath();
          drawCtx.moveTo(d.x1, d.y1);
          drawCtx.lineTo(d.x2, d.y2);
          drawCtx.strokeStyle = d.color;
          drawCtx.lineWidth = d.width;
          drawCtx.lineCap = 'round';
          drawCtx.stroke();
        });
        
        // Render notes
        photoData.notes.forEach(note => renderNote(note));
      };
      img.src = photoData.image;
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    function vibrate(ms) {
      if ('vibrate' in navigator) {
        navigator.vibrate(ms);
      }
    }

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swCode = `
          const CACHE_NAME = 'floatnote-v1';
          
          self.addEventListener('install', (e) => {
            e.waitUntil(
              caches.open(CACHE_NAME).then(cache => {
                return cache.addAll(['/']);
              })
            );
            self.skipWaiting();
          });
          
          self.addEventListener('activate', (e) => {
            e.waitUntil(
              caches.keys().then(keys => {
                return Promise.all(
                  keys.filter(key => key !== CACHE_NAME).map(key => caches.delete(key))
                );
              })
            );
            return self.clients.claim();
          });
          
          self.addEventListener('fetch', (e) => {
            e.respondWith(
              caches.match(e.request).then(response => {
                return response || fetch(e.request);
              })
            );
          });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl).then(() => {
          console.log('FloatNote PWA ready! üå∏');
        }).catch(err => {
          console.log('SW registration failed:', err);
        });
      });
    }

    // Install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showToast('Tap to install FloatNote! üì≤');
    });
