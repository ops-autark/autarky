<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ZenFoodie ‚Äì Calm Food Delivery</title>
  <link rel="manifest" href="manifest.json" />
  <!-- Zen Font and Icons -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Sen:400,700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><circle fill='%23A7C8BD' cx='24' cy='24' r='24'/><text x='24' y='32' font-size='20' text-anchor='middle' fill='%23fff' font-family='Verdana'>Á¶Ö</text></svg>" />
  <style>
    :root {
      /* Zen Calm Color Palette */
      --zen-bg: #f5f7f6;
      --zen-bg-dark: #e2e7e3;
      --zen-primary: #A7C8BD;
      --zen-accent: #646a67;
      --zen-soft: #f0f4f2;
      --zen-gradient: linear-gradient(180deg, #eafaf6 0%, #f8f6f3 100%);
      --zen-text: #393e41;
      --zen-shadow: 0 2px 16px 0 rgba(100, 120, 110, 0.07);

      --nav-height: 64px;
      --radius: 20px;
      --sp-xxs: 4px;
      --sp-xs: 8px;
      --sp-s: 16px;
      --sp-m: 24px;
      --sp-l: 40px;
      --transition: 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Sen', 'Montserrat', sans-serif;
      background: var(--zen-gradient);
      min-height: 100%;
      color: var(--zen-text);
      scroll-behavior: smooth;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--zen-gradient);
    }

    /* Zen Layout Containers */
    #app {
      display: flex;
      flex-direction: column;
      flex: 1 1 0;
      min-height: 0;
      justify-content: flex-start;
      align-items: stretch;
      max-width: 510px;
      margin: 0 auto;
      padding-bottom: var(--nav-height);
      box-sizing: border-box;
      width: 100vw;
    }
    header {
      width: 100%;
      min-height: 60px;
      padding: var(--sp-s) var(--sp-m);
      box-sizing: border-box;
      background: var(--zen-bg);
      border-bottom: 1px solid var(--zen-primary);
      box-shadow: var(--zen-shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1.3rem;
      z-index: 30;
    }
    .zen-title {
      font-family: 'Sen', 'Montserrat', sans-serif;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--zen-accent);
      text-shadow: 0 1px 0 #fff2, 0 2px 8px #a7c8bd33;
      user-select: none;
    }
    /* Dual Role Toggle Button */
    .role-toggle {
      background: var(--zen-primary);
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: var(--sp-xs) var(--sp-m);
      cursor: pointer;
      box-shadow: var(--zen-shadow);
      transition: background var(--transition), transform var(--transition);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: var(--sp-xs);
      outline: none;
      position: relative;
    }
    .role-toggle span.material-icons {
      font-size: 1.2em;
    }
    .role-toggle:active, .role-toggle:focus, .role-toggle:hover {
      background: #82b8a6;
      transform: scale(1.06);
      box-shadow: 0 4px 32px 0 rgba(100,120,110,0.10);
    }
    /* Zen Card Styles */
    .zen-card {
      background: var(--zen-soft);
      border-radius: var(--radius);
      box-shadow: var(--zen-shadow);
      padding: var(--sp-m);
      margin: var(--sp-s) 0;
      transition: box-shadow var(--transition), transform var(--transition);
      overflow: hidden;
      min-width: 0;
      position: relative;
    }
    .zen-card:hover, .zen-card:focus-within {
      box-shadow: 0 8px 32px 0 rgba(100,120,110,0.18);
    }

    /* Main Content Area */
    .main-content {
      flex: 1 1 0;
      padding: var(--sp-s) var(--sp-m) var(--sp-l) var(--sp-m);
      box-sizing: border-box;
      min-height: 60vh;
    }

    .zen-section-title {
      margin-top: 0;
      font-size: 1.18rem;
      font-weight: bold;
      letter-spacing: 1px;
    }

    /* Restaurant & Menu List */
    .restaurant-list, .order-list, .delivery-list {
      display: flex;
      flex-direction: column;
      gap: var(--sp-s);
      margin-top: var(--sp-xs);
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: var(--sp-s);
      padding: var(--sp-xs) 0;
      border-bottom: 1px dashed #e2e7e3;
      transition: background var(--transition);
    }
    .menu-item:last-child {
      border-bottom: none;
    }
    .menu-img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 12px;
      background: var(--zen-bg-dark);
      box-shadow: var(--zen-shadow);
      transition: transform var(--transition);
    }
    .menu-item:hover .menu-img {
      transform: scale(1.05);
    }
    .menu-detail {
      flex: 1;
    }
    .menu-title {
      font-weight: 500;
      margin: 0 0 5px 0;
    }
    .menu-desc {
      font-size: 0.91rem;
      color: #646a6799;
      margin-bottom: 2px;
    }
    .menu-price {
      color: var(--zen-primary);
      font-weight: 600;
      font-size: 1.09em;
    }
    /* Button Styles */
    .zen-btn {
      background: var(--zen-primary);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: var(--sp-xs) var(--sp-m);
      font-size: 0.99em;
      font-family: inherit;
      margin-left: var(--sp-xs);
      cursor: pointer;
      box-shadow: var(--zen-shadow);
      transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
      outline: none;
      display: inline-flex;
      gap: var(--sp-xs);
      align-items: center;
    }
    .zen-btn:active, .zen-btn:focus, .zen-btn:hover {
      background: #82b8a6;
      transform: scale(1.05);
      box-shadow: 0 6px 18px 0 rgba(100,120,110,0.11);
    }
    .zen-btn.secondary {
      background: #e2e7e3;
      color: var(--zen-accent);
    }
    /* Zen Map */
    .zen-map {
      width: 100%;
      height: 160px;
      border-radius: 16px;
      background: linear-gradient(97deg, #eafaf6 0%, #a7c8bd 100%);
      margin: var(--sp-s) 0;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0px 16px 0 rgba(100,120,110,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: mapWave 7s linear infinite alternate;
    }
    @keyframes mapWave {
      0% { background-position: 0 0;}
      100% { background-position: 130px 77px;}
    }
    .map-marker {
      width: 32px;
      height: 32px;
      border-radius: 99px;
      background: #ffeccf;
      box-shadow: 0 1px 12px 0 #fad9af76;
      border: 2.5px solid #a7c8bd88;
      position: absolute;
      left: 48%;
      top: 55%;
      transform: translate(-50%,-55%) scale(1);
      z-index: 9;
      animation: markerPulse 2.3s ease-in-out infinite;
    }
    @keyframes markerPulse {
      0% { box-shadow: 0 0px 6px 0 #fad9af56;}
      50% { box-shadow: 0 0px 16px 6px #ffeccfaa;}
      100% { box-shadow: 0 0px 6px 0 #fad9af56;}
    }
    /* Bottom Navigation Tray */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 524px;
      background: var(--zen-soft);
      border-radius: 30px 30px 0 0;
      box-shadow: 0 3px 28px 0 rgba(100, 120, 110, 0.13);
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: var(--nav-height);
      z-index: 1000;
      transition: box-shadow var(--transition);
      font-size: 1.09rem;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      user-select: none;
    }
    .bottom-nav button {
      background: none;
      border: none;
      color: var(--zen-accent);
      padding: var(--sp-xs);
      flex: 1 1 0;
      font-family: inherit;
      font-size: 1.028em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      transition: color var(--transition);
      cursor: pointer;
      border-radius: 16px;
      outline: none;
    }
    .bottom-nav button.active,
    .bottom-nav button:focus,
    .bottom-nav button:hover {
      color: var(--zen-primary);
      background: #eafaf6cc;
    }
    .bottom-nav .material-icons {
      font-size: 1.47em;
      margin-bottom: 0px;
      margin-top: 3px;
    }
    /* Modal Styles */
    .zen-modal-backdrop {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: #e2e7e3dd;
      justify-content: center;
      align-items: center;
    }
    .zen-modal {
      background: var(--zen-soft);
      border-radius: var(--radius);
      box-shadow: 0 0 28px 0 #a7c8bd66;
      min-width: 80vw; max-width: 400px;
      padding: var(--sp-m);
      text-align: center;
      animation: modalFadeIn 0.4s;
      position: relative;
      z-index: 2;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.90);}
      to { opacity: 1; transform: scale(1);}
    }
    .zen-modal-backdrop.active { display: flex; }
    /* Microanimations */
    [data-zen-anim] {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity .6s var(--transition), transform .7s var(--transition);
    }
    [data-zen-anim].show {
      opacity: 1;
      transform: none;
    }
    /* Profile/Settings */
    .zen-profile-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--sp-s);
      padding: var(--sp-xs) 0;
    }
    .zen-profile-label {
      font-size: 1em;
      font-weight: 600;
      color: var(--zen-accent);
    }
    .zen-profile-value, .zen-settings-switch {
      font-size: 1em;
      color: var(--zen-primary);
      padding-left: var(--sp-xs);
    }
    /* Simple Switch Toggle */
    .zen-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      margin-left: var(--sp-xs);
      vertical-align: middle;
    }
    .zen-switch input {
      opacity: 0; width: 0; height: 0;
    }
    .zen-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #e2e7e3;
      border-radius: 24px;
      transition: background var(--transition);
    }
    .zen-slider:before {
      position: absolute;
      content: "";
      height: 18px; width: 18px; left: 3px; bottom: 3px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 5px #a7c8bd33;
      transition: transform var(--transition);
    }
    .zen-switch input:checked + .zen-slider {
      background: var(--zen-primary);
    }
    .zen-switch input:checked + .zen-slider:before {
      transform: translateX(20px);
    }

    /* Responsive Design */
    @media (min-width: 620px) {
      .main-content {
        padding: var(--sp-l) var(--sp-l) var(--nav-height) var(--sp-l);
      }
      #app {
        margin: var(--sp-l) auto var(--nav-height) auto;
        border-radius: 24px;
        box-shadow: var(--zen-shadow);
        background: var(--zen-gradient);
      }
    }

    @media (min-width: 950px) {
      #app {
        margin: var(--sp-l) auto var(--nav-height) auto;
        max-width: 530px;
      }
      .bottom-nav {
        border-radius: 16px;
        max-width: 530px;
      }
      .main-content {
        padding: var(--sp-l) var(--sp-xl) var(--nav-height) var(--sp-xl);
      }
    }
    /* Hide scrollbars */
    ::-webkit-scrollbar {
      width: 0px !important;
      background: transparent;
    }
    /* End Zen CSS */
  </style>
</head>
<body>
  <div id="app">
    <header>
      <span class="zen-title">Á¶Ö ZenFoodie</span>
      <button class="role-toggle" id="roleToggleBtn" aria-label="Switch role">
        <span id="roleIcon" class="material-icons" aria-hidden="true">person</span>
        <span id="roleLabel">Customer</span>
      </button>
    </header>

    <main class="main-content" id="mainContent">
      <!-- Content gets injected here -->
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" aria-label="Application Navigation">
      <button id="navHome" class="active" data-page="home"><span class="material-icons">home</span>Home</button>
      <button id="navOrders" data-page="orders"><span class="material-icons">assignment</span>Orders</button>
      <button id="navProfile" data-page="profile"><span class="material-icons">person</span>Profile</button>
      <button id="navRole" data-page="role"><span class="material-icons">swap_horiz</span>Role</button>
    </nav>
  </div>
  <!-- Modal for notifications & offline -->
  <div class="zen-modal-backdrop" id="modalBackdrop" tabindex="-1" aria-modal="true">
    <div class="zen-modal" id="modalBox" role="dialog"></div>
  </div>
  <!-- Zen Mock Map SVG (hidden, injected as needed) -->
  <template id="zenMapTemplate">
    <div class="zen-map">
      <svg width="100%" height="100%" viewBox="0 0 350 100" fill="none" xmlns="http://www.w3.org/2000/svg" style="position:absolute; top:0;left:0;">
        <ellipse cx="175" cy="60" rx="120" ry="25" fill="#a7c8bd" fill-opacity="0.2"/>
        <ellipse cx="60" cy="85" rx="25" ry="6" fill="#a7c8bd99"/>
        <ellipse cx="285" cy="50" rx="30" ry="8" fill="#a7c8bd55"/>
      </svg>
      <div class="map-marker"></div>
    </div>
  </template>
  <!-- Firebase App Placeholders (Uncomment & configure in real deployment) -->
  <!--
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js"></script>
    <script>
      // TODO: Replace with real keys
      const firebaseConfig = {
        apiKey: "",
        authDomain: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: ""
      };
      firebase.initializeApp(firebaseConfig);
      // const db = firebase.firestore();
      // const auth = firebase.auth();
    </script>
  -->
  <script>
    /* ------------------------------------------
     * ZenFoodie App - Zen Delivery in One File!
     * ------------------------------------------ */

    // Local mock data for demo and offline cache
    const DUMMY_RESTAURANTS = [
      {
        id: '1',
        name: 'Calm Bowl Eatery',
        desc: 'Healthy, slow-cooked Asian bowls.',
        logo: 'https://source.unsplash.com/64x64/?bowl,food,zen',
        menu: [
          {id:'m1',name:'Zen Quinoa Pilaf',desc:'Herbs, lemon zest, seeds',price:169,img:'https://source.unsplash.com/88x88/?quinoa,bowl,food'},
          {id:'m2',name:'Tofu Harmony Curry',desc:'Tofu, veggies, jasmine rice',price:219,img:'https://source.unsplash.com/88x88/?curry,vegan,tofu'},
          {id:'m3',name:'Miso Serenity Soup',desc:'Silky broth w/ mushrooms',price:129,img:'https://source.unsplash.com/88x88/?soup,zen'}
        ]
      },
      {
        id: '2',
        name: 'Minimal Tea House',
        desc: 'Organic teas and light bites.',
        logo: 'https://source.unsplash.com/64x64/?tea,minimal',
        menu: [
          {id:'m4',name:'Matcha Cloud','desc':'Ceremonial matcha, almond milk',price:99,img:'https://source.unsplash.com/88x88/?matcha,tea,latte'},
          {id:'m5',name:'Lotus Rice Wraps',desc:'Rice paper, sprouts, sauce',price:135,img:'https://source.unsplash.com/88x88/?rice,springrolls'},
        ]
      }
    ];

    const DUMMY_ORDERS = [
      { id:'o1', rest:'Calm Bowl Eatery', items:[{menu:'Zen Quinoa Pilaf',qty:1}], status:'preparing', total:169, eta:'12 min', placed:new Date(Date.now()-11*60000).toISOString(), address:'15 Zen Lane'},
      { id:'o2', rest:'Minimal Tea House', items:[{menu:'Lotus Rice Wraps',qty:2}], status:'delivered', total:270, eta:'-', placed:new Date(Date.now()-53*60000).toISOString(), address:'28 Lotus St' }
    ];

    /* ----
     * Default Settings
     */
    const STORAGE_KEY = "ZenFoodieApp";
    const ZEN_DEFAULTS = {
      role: "customer",
      lastOrder: null,
      ui: {
        softMode: true,
        colorMode: "default"
      }
    };

    /* ----
     * Utility Methods
     */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const delay = ms => new Promise(res=>setTimeout(res,ms));
    const on = (el, ev, fn) => el && el.addEventListener(ev, fn);

    function saveState(state) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {...ZEN_DEFAULTS};
      } catch { return {...ZEN_DEFAULTS}; }
    }
    /* ----- Basic IndexedDB Caching ---- */
    let idb = null;
    function zenOpenIDB() {
      return new Promise(res => {
        if(idb) { res(idb); return; }
        let req = indexedDB.open("ZenFoodieDB", 1);
        req.onupgradeneeded = (evt) => {
          let db = evt.target.result;
          if (!db.objectStoreNames.contains("menus")) db.createObjectStore("menus");
          if (!db.objectStoreNames.contains("orders")) db.createObjectStore("orders");
        };
        req.onsuccess = evt => { idb = evt.target.result; res(idb); };
      });
    }
    function zenIDBSet(store, key, val) {
      return zenOpenIDB().then(db=>{
        return new Promise(res=>{
          let tx = db.transaction(store, "readwrite");
          tx.objectStore(store).put(val, key);
          tx.oncomplete = () => res(true);
        });
      });
    }
    function zenIDBGet(store, key) {
      return zenOpenIDB().then(db=>{
        return new Promise(res=>{
          let tx = db.transaction(store, "readonly");
          let req = tx.objectStore(store).get(key);
          req.onsuccess = () => res(req.result||null);
        });
      });
    }

    /* ----
     * State Management
     */
    let state = {...ZEN_DEFAULTS, ...loadState()};
    let prevHash = window.location.hash;

    // Persist state on any role/UI/order changes
    function updateState(obj) {
      state = { ...state, ...obj };
      saveState(state);
    }

    // Responsive Zen Animation when content loads
    function zenReveal() {
      requestAnimationFrame(()=>{
        $$('[data-zen-anim]').forEach(el=>{
          el.classList.remove('show');
          setTimeout(()=>el.classList.add('show'), 42);
        });
      });
    }

    /* ----
     * Role Handling
     */
    const roles = {
      customer: { icon: "person", label: "Customer" },
      delivery: { icon: "motorcycle", label: "Delivery" }
    };
    function setRole(r) {
      if(!roles[r]) return;
      updateState({role:r});
      $('#roleLabel').textContent = roles[r].label;
      $('#roleIcon').textContent = roles[r].icon;
      // Show/hide app elements as needed
      renderNavHighlight();
      renderMain();
    }

    // Toggle role on header button or nav tray
    function toggleRole() {
      let next = (state.role==='customer') ? 'delivery' : 'customer';
      setRole(next);
    }

    /* ---
     * NAVIGATION LOGIC
     */
    const pages = ['home','orders','profile','role'];
    let currentPage = 'home';

    function renderNavHighlight() {
      $$('.bottom-nav button').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.page===currentPage || (btn.dataset.page==="role" && currentPage==="role"));
      });
    }

    function goPage(page) {
      currentPage = page;
      renderNavHighlight();
      renderMain();
    }

    // Modal Dialog
    function showModal(html, ms=2200) {
      const modal = $('#modalBackdrop');
      $('#modalBox').innerHTML = html;
      modal.classList.add('active');
      if(ms && ms>0) setTimeout(()=>modal.classList.remove('active'), ms);
    }
    function hideModal(){
      $('#modalBackdrop').classList.remove('active');
    }
    on($('#modalBackdrop'),'click', (e)=>{
      if(e.target === $('#modalBackdrop')) hideModal();
    });

    /* -------------
     * MAIN UI RENDER
     * ------------- */

    function renderMain() {
      let root = $('#mainContent'), html = "";
      // Mobile: Remove scroll to top? Or animate.
      window.scrollTo({top:0,behavior:'auto'});
      if(currentPage==='home') {
        if(state.role==='customer') html = renderCustomerHome();
        else html = renderDeliveryHome();
      } else if(currentPage==='orders') {
        html = renderOrders();
      } else if(currentPage==='profile') {
        html = renderProfile();
      } else if(currentPage==='role') {
        html = renderRoleSwitch();
      }
      root.innerHTML = html;
      zenReveal();
      // Map integration in orders for delivery tracking
      if(currentPage==='orders' && state.role==='customer' && state.lastOrder && (state.lastOrder.status==='on-way'||state.lastOrder.status==='preparing')) {
        injectMap();
      }
    }

    /* ------
     * CUSTOMER: HOME: List restaurants
     * ------ */
    function renderCustomerHome() {
      let restHTML = DUMMY_RESTAURANTS.map(r=>`
        <div class="zen-card" data-zen-anim>
          <div style="display: flex; align-items: center; gap: var(--sp-s); margin-bottom: 6px;">
            <img src="${r.logo}" alt="${r.name} logo" style="width:48px;height:48px;border-radius:12px;background:var(--zen-bg-dark);" />
            <div style="flex:1">
              <div class="menu-title">${r.name}</div>
              <div style="font-size:0.97em;color:#646a679a">${r.desc}</div>
            </div>
            <button class="zen-btn" onclick="showRestaurantMenu('${r.id}')"><span class="material-icons">restaurant_menu</span>Menu</button>
          </div>
        </div>
      `).join('');
      return `
        <h2 class="zen-section-title" data-zen-anim>Discover Zen Eateries</h2>
        <div class="restaurant-list" data-zen-anim>
          ${restHTML}
        </div>
      `;
    }

    // Show Restaurant Menu Modal
    window.showRestaurantMenu = function(restid) {
      const rest = DUMMY_RESTAURANTS.find(r=>r.id===restid);
      if(!rest) return;
      let menuHTML = rest.menu.map(m=>`
        <div class="menu-item">
          <img class="menu-img" src="${m.img}" alt="${m.name}"/>
          <div class="menu-detail">
            <div class="menu-title">${m.name}</div>
            <div class="menu-desc">${m.desc}</div>
            <div class="menu-price">‚Çπ${m.price}</div>
          </div>
          <button class="zen-btn" onclick="addToOrder('${restid}','${m.id}')"><span class="material-icons">add</span></button>
        </div>`).join('');
      showModal(`
        <div>
          <div style="font-weight:700;font-size:1.11em;margin-bottom:8px">
            ${rest.name} <span style="font-size:1.3em">${String.fromCharCode(0x1F35A)}</span>
          </div>
          <div>${menuHTML}</div>
        </div>
      `,0);
    };

    // Add menu item to order draft, user confirms ordering via UI
    window.addToOrder = function(restid, menuid) {
      const rest = DUMMY_RESTAURANTS.find(r=>r.id===restid);
      const menu = rest.menu.find(m=>m.id===menuid);
      let order = {
        id:'new_'+Date.now(),
        rest: rest.name,
        items: [{menu: menu.name, qty:1}],
        status: 'preparing',
        total: menu.price,
        eta:'~15 min',
        placed: new Date().toISOString(),
        address: 'Your saved address'
      };
      let confirmHTML = `
        <div>
          <div style="font-weight:bold">Order Confirmation</div>
          <div style="margin:10px auto">
            1 x ${menu.name}<br>
            <b>From:</b> ${rest.name}<br>
            <b>To:</b> Your saved address
          </div>
          <div class="menu-price" style="margin-bottom:10px;">Total: ‚Çπ${menu.price}</div>
          <button class="zen-btn" onclick="confirmOrder('${order.id}')">Place Order</button>
        </div>
      `;
      showModal(confirmHTML,0);
      // Save to window for confirm
      window.ZenOrderDraft = order;
    };
    window.confirmOrder = function(orderid){
      if(window.ZenOrderDraft && window.ZenOrderDraft.id===orderid) {
        state.lastOrder = window.ZenOrderDraft;
        // Save to localStorage & cache to IndexedDB
        updateState({lastOrder: state.lastOrder});
        zenIDBSet('orders','lastOrder',state.lastOrder);
        showModal('<div><span class="material-icons" style="color:var(--zen-primary);font-size:2em;">check_circle</span><br>Order placed!<br><em>Breathe. We track it for you.</em></div>');
        goPage('orders');
      }
    };

    /* ------
     * CUSTOMER: ORDERS
     * ------ */
    function renderOrders() {
      if(state.role==='customer') {
        let currOrder = state.lastOrder;
        if(currOrder) {
          let orderStatusColor =
            currOrder.status==='preparing' ? '#a7c8bd'
            : currOrder.status==='on-way' ? '#82b8a6'
            : currOrder.status==='delivered' ? "#8cad69" : "#c8c8a7";
          return `
            <div class="zen-card" data-zen-anim>
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div class="zen-section-title">Latest Order ‚Äì <span style="color:${orderStatusColor};text-transform:capitalize">${currOrder.status}</span></div>
                  <div style="font-size:0.97em;color:#646a679a">at ${currOrder.rest}</div>
                </div>
              </div>
              <div style="margin:10px 0 0 8px;">
                <ul>
                  ${currOrder.items.map(i=>`<li>${i.qty} x ${i.menu}</li>`).join('')}
                </ul>
                <div>To: ${currOrder.address}</div>
              </div>
              <div style="margin:7px 0 3px 8px;">
                <span class="menu-price">Total: ‚Çπ${currOrder.total}</span>
                <span style="float:right;"> ETA: ${currOrder.eta}</span>
              </div>
              ${currOrder.status==='on-way'||currOrder.status==='preparing'
                ? `<div id="orderMap"></div><div style="text-align:center;color:var(--zen-primary);font-size:0.98em;"><span class="material-icons" style="vertical-align:middle">delivery_dining</span>
                  Delivery tracking enabled
                </div>`
                : ""}
            </div>
          `;
        } else {
          return `
            <div class="zen-card" data-zen-anim>
              <div class="zen-section-title">No active orders.</div>
              <div style="margin-top:10px;">Order your favorite bowl and track it real-time.</div>
            </div>
          `;
        }
      } else { // Delivery Person view
        let myDeliveries = DUMMY_ORDERS.filter(o=>o.status==='preparing'||o.status==='on-way');
        let ordersHTML = myDeliveries.length ? myDeliveries.map(o=>`
          <div class="zen-card" data-zen-anim style="position:relative;">
            <div style="display:flex;justify-content:space-between">
              <div>
                <div style="font-weight:bold;">${o.rest}</div>
                <div style="font-size:0.89em;color:#646a677a">To: ${o.address||'Unknown'}</div>
              </div>
              <div style="font-size:0.96em;margin:6px 0;">
                <span class="menu-price">‚Çπ${o.total}</span>
              </div>
            </div>
            <div style="margin:4px 0 8px 8px;">
              Items: ${o.items.map(x=>`${x.qty}x ${x.menu}`).join(', ')}
            </div>
            <div>
               <span class="zen-btn secondary" onclick="updateDeliveryStatus('${o.id}','on-way')">Pick Up</span>
               <span class="zen-btn" onclick="updateDeliveryStatus('${o.id}','delivered')">Delivered</span>
            </div>
            <div style="position:absolute;top:13px;right:20px;color:#a7c8bd;font-size:1.13em">${o.status==='on-way'?'üöö':'üõçÔ∏è'}</div>
          </div>
        `).join('') : `<div class="zen-card" data-zen-anim>No pending deliveries.<br>Stay calm, new requests coming soon.</div>`;
        return `
          <h2 class="zen-section-title" data-zen-anim>Active Deliveries</h2>
          <div class="delivery-list" data-zen-anim>
            ${ordersHTML}
          </div>
        `;
      }
    }

    // Delivery person can update delivery status (mocked, stateful in-memory)
    window.updateDeliveryStatus = function(orderid, status) {
      // Normally, you would push this to Firestore
      let found = DUMMY_ORDERS.find(o=>o.id===orderid);
      if(found) {
        found.status = status;
        showModal(`<span class="material-icons" style="font-size:1.8em;color:var(--zen-primary);">check_circle</span>
        Order marked as <b>${status.replace('-',' ')}</b>!`,1300);
        renderMain();
      }
    };

    // CUSTOMER: Render animated delivery map
    function injectMap() {
      const mapTpl = $('#zenMapTemplate').content.cloneNode(true);
      $('#orderMap').appendChild(mapTpl);
    }

    /* ------
     * PROFILE / PREFERENCES
     * ------ */
    function renderProfile() {
      return `
        <div class="zen-card" data-zen-anim>
          <h2 class="zen-section-title">Your Profile</h2>
          <div class="zen-profile-row">
            <div class="zen-profile-label">Role:</div>
            <div class="zen-profile-value">${roles[state.role].label}</div>
          </div>
          <div class="zen-profile-row">
            <div class="zen-profile-label">Soft UI Mode:</div>
            <label class="zen-switch">
              <input type="checkbox" id="toggleSoftMode" ${state.ui && state.ui.softMode ? 'checked':''}>
              <span class="zen-slider"></span>
            </label>
          </div>
          <div class="zen-profile-row">
            <div class="zen-profile-label">Restore last order:</div>
            <span>
              <button class="zen-btn secondary" onclick="restoreLastOrder()">Restore</button>
            </span>
          </div>
          <div style="font-size:0.92em;color:#646a6787">
            Preferences are saved locally and work offline!
          </div>
        </div>
      `;
    }
    // Soft UI Mode Toggle
    on(document,'change',e=>{
      if(e.target && e.target.id==='toggleSoftMode') {
        updateState({ui:{...state.ui,softMode:e.target.checked}});
        showModal(`<span style="color:var(--zen-primary)">Soft Mode: ${e.target.checked?'On':'Off'}</span>`,1100);
      }
    });

    window.restoreLastOrder = function() {
      zenIDBGet('orders','lastOrder').then(data=>{
        if(data) {
          state.lastOrder=data;
          updateState({lastOrder: data});
          showModal("Order restored.", 1100);
        } else {
          showModal("No previous order found.",1300);
        }
      });
    };

    /* -----
     * ROLE SWITCH
     */
    function renderRoleSwitch() {
      return `
        <div class="zen-card" data-zen-anim style="text-align:center">
          <span style="font-size:1.89em;color:var(--zen-primary)">
            <span class="material-icons">${state.role==='customer'?'person':'motorcycle'}</span>
          </span><br>
          <div style="font-size:1.11em;margin-bottom:7px;">
            Current mode: <b>${roles[state.role].label}</b>
          </div>
          <button class="zen-btn" onclick="toggleRole()">
            <span class="material-icons">swap_horiz</span> Switch to ${roles[state.role==='customer'?'delivery':'customer'].label}
          </button>
        </div>
      `;
    }

    /* -----
     * DELIVERY MODE: Home
     */
    function renderDeliveryHome() {
      let html = `
        <h2 class="zen-section-title" data-zen-anim>Welcome, Delivery Partner</h2>
        <div class="zen-card" data-zen-anim>
          <div style="font-size:1.05em">
            See all orders ready for pickup and delivery.<br>
            Tap an order to update its status.
          </div>
        </div>
      `;
      return html;
    };

    /* -----
     * OFFLINE SUPPORT: Service Worker Registration
     */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => {
          // Optional: confirmation
        }).catch(() => {});
      });
    }

    /* ------
     * FIREBASE PLACEHOLDERS
     * Insert real API calls when ready.
     */
    function initFirebase() {
      // Place your Firebase initialization, auth, Firestore, Storage setup here.
      // See commented <script> in HTML head.
    }
    function realtimeOrderUpdates(cb) {
      // Place Firestore real-time listener here.
      // On order changes: cb(order)
    }
    // Replace all uses of DUMMY_* arrays with real Firestore queries in production

    /* ------
     * UI INIT/ROUTING/LOAD
     * ------ */
    function firstLoad() {
      // LocalStorage/IDB restoration
      if(!state.lastOrder) {
        zenIDBGet('orders','lastOrder').then(order=>{
          if(order) {
            updateState({lastOrder:order});
            renderMain();
          }
        });
      }
    }

    // Event listeners for nav tray and role button
    $$('.bottom-nav button').forEach(btn=>{
      on(btn,'click',(e)=>{
        let p = btn.dataset.page;
        if(p==="role"){ toggleRole(); goPage('home'); }
        else goPage(p);
      });
    });
    on($('#roleToggleBtn'), 'click', toggleRole);

    // Listen for hash or hard refresh navigation (single page)
    window.addEventListener('hashchange', ()=>{
      if(location.hash !== prevHash) {
        const page = location.hash.replace(/^#/,'');
        if(pages.includes(page)) goPage(page);
        prevHash = location.hash;
      }
    });

    // Zen Anim reveal on new page render
    renderNavHighlight();
    setRole(state.role || 'customer');
    renderMain();
    firstLoad();
  </script>
  <!-- Service Worker inlined for monorepo format. Save as sw.js if required. -->
  <script id="inline-sw" type="text/plain">
    // sw.js
    const CACHE_NAME = 'zenfoodie-static-v1';
    const FILES_TO_CACHE = [
      '/', '/index.html', // required for PWA
    ];

    self.addEventListener('install', (evt) => {
      evt.waitUntil(
        caches.open(CACHE_NAME).then(cache => {
          return cache.addAll(FILES_TO_CACHE);
        })
      );
      self.skipWaiting();
    });

    self.addEventListener('activate', evt => {
      evt.waitUntil(
        caches.keys().then(keys => {
          return Promise.all(keys.map(k=>{
            if(k!==CACHE_NAME) return caches.delete(k);
          }));
        })
      );
      self.clients.claim();
    });

    self.addEventListener('fetch', evt => {
      evt.respondWith(
        caches.match(evt.request).then(response => {
          return response || fetch(evt.request);
        })
      );
    });
  </script>
  <script>
    // Inline Service Worker Loader for monorepo usage
    if('serviceWorker' in navigator) {
      const swCode = document.getElementById('inline-sw').textContent.trim();
      const blob = new Blob([swCode], {type: 'text/javascript'});
      const swURL = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swURL).catch(()=>{});
    }
  </script>
</body>
</html>
