<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaper ‚Äì Zen Moodboard & Silent Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <!-- Google Fonts: Zen/Minimal -->
  <link href="https://fonts.googleapis.com/css2?family=Sen:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* ---- Zen Calm Global Styles ---- */
    :root {
      --bg-main: #f7f6f3;
      --bg-jp: linear-gradient(120deg,#e3e2db 0,#f7eee3 35%,#cfe6df 100%);
      --primary: #798478;
      --accent: #c4ae7b;
      --accent-2: #a2cfcf;
      --note: #fdf7e9;
      --note2: #eaf3ee;
      --text: #2d2e2c;
      --zen-shadow: 0 3px 28px 0 #bfc8ce4d;
      --radius: 22px;
      --sp-s: 11px;
      --sp-m: 21px;
    }
    html,body {
      min-height:100vh; margin:0; padding:0;
      font-family: 'Sen','Montserrat',sans-serif;
      background: var(--bg-jp);
      color: var(--text);
    }
    #app {
      min-height:100vh;
      display:flex; flex-direction:column;
      align-items:center;
      width:100vw; max-width:600px; margin:0 auto;
      box-sizing:border-box;
      padding-bottom:87px;
    }
    header {
      width:100%; max-width:600px;
      display:flex; align-items:center; justify-content:space-between;
      background:var(--note2); border-radius:0 0 22px 22px;
      box-shadow: var(--zen-shadow);
      margin-bottom:var(--sp-m);
      padding:var(--sp-s) var(--sp-m);
    }
    .zen-logo {
      font-family:'Sen','Montserrat',sans-serif; font-size:1.28em;
      color:var(--primary); font-weight:800; letter-spacing:2px;
      text-shadow:0 1px 0 #fff6,0 3px 18px #bfc8ce22;
      user-select:none;
    }
    nav.bottom-nav {
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:0; z-index:1000;
      background:var(--note); width:100vw; max-width:600px;
      border-radius:27px 27px 0 0;
      box-shadow: 0 -2px 20px #cacaa633;
      display:flex; justify-content:space-around;
      height:67px;
      align-items:center;
    }
    nav.bottom-nav button {
      outline:none; border:none; background:transparent;
      font-family:inherit; color:var(--primary);
      font-size:1.04em; display:flex; flex-direction:column;
      align-items:center; gap:1.6px;
      cursor:pointer; border-radius:16px; padding:7px 7px;
      transition:background .26s,color .26s;
    }
    nav.bottom-nav button.active,
    nav.bottom-nav button:focus,
    nav.bottom-nav button:hover {
      background: var(--accent-2);
      color:#fff;
    }
    main { width:96vw; max-width:570px;}
    /* ----- Moodboard ----- */
    .moodboard {
      padding:var(--sp-m) 2vw; display:flex;
      flex-direction:column; align-items:center;
    }
    .note-board-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(178px,1fr));
      gap: var(--sp-m); width:100%;
    }
    .note-tile {
      background: var(--note);
      border-radius:17px;
      padding:var(--sp-s) var(--sp-m);
      box-shadow:0 2px 13px #eeeae7bb;
      font-family:inherit; font-size:1.09em;
      margin-bottom: var(--sp-xs);
      display:flex; flex-direction:column; gap:2px;
      min-height:58px; transition:box-shadow .2s;
      position:relative; word-wrap:break-word;
      animation:boardIn .7s;
    }
    .note-tile .lang { font-size:0.78em; color:#b7b7b7;}
    .note-public-mark {
      position:absolute;top:6px;right:11px;font-size:1em;color:var(--primary);
    }
    @keyframes boardIn { from{opacity:.2;transform:translateY(22px)} to{opacity:1;transform:none} }
    /* ----- New Note Section ----- */
    .note-form-modal {
      background: var(--note2); border-radius:18px;
      box-shadow:var(--zen-shadow); margin:var(--sp-s) 0;
      padding:var(--sp-m) var(--sp-m) var(--sp-s) var(--sp-m);
      display:flex; flex-direction:column; align-items:stretch;
      animation:modalFadeIn .6s;
    }
    @keyframes modalFadeIn { from{opacity:0;transform:scale(.95);} to{opacity:1;transform:none}}
    textarea#newNote {
      width:96%; min-height:49px; padding:10px;
      font-size:1.09em; border-radius:12px;
      border:1.5px solid #dedad1; font-family:inherit;
      background:#fff6; color:var(--text);
      resize:none; outline:none;
      transition:border .23s;
    }
    textarea#newNote:focus { border:1.5px solid var(--primary);}
    .note-action-row {
      display:flex; align-items:center; gap:9px; margin-top: var(--sp-s);
      justify-content:space-between;
    }
    .toggle-public {
      display:flex; align-items:center; gap:2px;
      cursor:pointer;
      font-size:0.99em;
    }
    .toggle-public input {margin-right:4px;}
    .note-btn {
      background:var(--primary);color:#fff;
      border:none; outline:none;
      border-radius:12px; padding:7px 21px;
      font-family:inherit;font-size:1em; cursor:pointer;
      box-shadow:var(--zen-shadow); transition:background .19s,transform .13s;
    }
    .note-btn:hover, .note-btn:focus {background:var(--accent);}
    /* ---- Focus Room: Video Room ---- */
    .focus-room {
      background: var(--bg-jp); padding:var(--sp-m) 1vw;
      border-radius:20px; margin-top:var(--sp-m);
      box-shadow:0 4px 24px 2px #a2cfcf33;
      display:flex; flex-direction:column;align-items:center;
      animation:boardIn .8s;
    }
    .focus-header {
      display:flex; justify-content:space-between;
      align-items:center; width:100%;
      margin-bottom:5px;
    }
    .video-grid {
      display:flex; flex-wrap:wrap; gap:var(--sp-m); justify-content:center;
      margin:var(--sp-m) 0; width:100%;
    }
    .video-tile {
      background:rgba(255,255,255,.34);
      border-radius:11px; overflow:hidden;
      display:flex; flex-direction:column;
      align-items:center; box-shadow:0 2px 17px #5b66793a;
      min-width:94px; min-height:103px; width:130px;
      gap:3px;
      aspect-ratio:11/13;
      position:relative;
    }
    .video-name {
      font-size:0.89em; color:#616e5d;
      font-weight:600; background:#fff8;
      border-radius:0 0 8px 8px; width:100%; text-align:center; padding:3px 2px;
    }
    .me-badge {
      font-size:0.76em; color:#acc; padding:3px;
      background:#b3ccb933;border-radius:7px;position:absolute;left:8px;top:8px;
    }
    /* --- Zen BGs & Ambient --- */
    .zen-bg-jp {
      background:url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?fit=crop&w=900&q=40');
      background-size:cover;
      border-radius:18px; min-height:130px;
      margin-bottom:var(--sp-m);
      filter:brightness(1) contrast(1.06) sepia(.1) blur(1px);
    }
    .zen-bg-blur {
      background:linear-gradient(125deg,#fbeec1aa 0,#c6e5c0aa 100%);
      filter:blur(2px) brightness(.97);
    }
    /* --- Ambient Music Bar --- */
    .music-bar {
      display:flex;align-items:center;gap:7px;
      font-size:0.89em;margin-bottom:9px;
    }
    .music-bar select, .music-bar button {
      background:var(--note2);border:none;font-family:inherit;
      border-radius:10px;padding:4px 9px;
    }
    .music-bar button {cursor:pointer;}
    /* -- Responsive -- */
    @media (max-width:540px){
      #app,main{max-width:99vw;}
      .video-tile{width:29vw;min-width:81px;}
    }
    @media (max-width:420px){
      .note-board-grid{grid-template-columns:1fr;}
      nav.bottom-nav{height:54px;}
    }
  </style>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <span class="zen-logo">Á¶Ö CalmPaper</span>
      <button id="roomBtn" class="note-btn" tabindex="0"><span class="material-icons" style="font-size:1.2em">video_camera_front</span>Focus Room</button>
    </header>
    <main id="main">
      <!-- Content rendered here -->
    </main>
    <nav class="bottom-nav" aria-label="Navigation">
      <button data-page="moodboard" class="active"><span class="material-icons">dashboard</span>Moodboard</button>
      <button data-page="room"><span class="material-icons">video_camera_front</span>Focus Room</button>
    </nav>
  </div>
  <audio id="ambient" loop>
    <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b9e8aab.mp3" type="audio/mp3">
  </audio>
  <script>
    // ----- Ambient Music (can swap to more tracks)
    const AMBIENT_TRACKS = [
      {name:'Zen Garden', src:'https://cdn.pixabay.com/audio/2022/03/15/audio_115b9e8aab.mp3'},
      {name:'Mountain Stream', src:'https://cdn.pixabay.com/audio/2022/03/03/audio_1152d09bfa.mp3'},
      {name:'Night Sakura', src:'https://cdn.pixabay.com/audio/2023/04/11/audio_129e313347.mp3'},
      {name:'Temple Rain', src:'https://cdn.pixabay.com/audio/2022/03/15/audio_115b9e8aab.mp3'}
    ];
    let ambient = document.getElementById('ambient');
    let currentTrack = 0;
    function playAmbient(idx) {
      let t = AMBIENT_TRACKS[idx||0];
      if(!t) return;
      ambient.src = t.src; ambient.play(); currentTrack=idx||0;
    }
    // ---- Moodboard & Notes ----
    const MOOD_KEY = "calmpaper_notes";
    let state = {
      page:'moodboard',
      notes: [],
      isPublic:false
    };

    function loadNotes() {
      try {
        let notes = JSON.parse(localStorage.getItem(MOOD_KEY) || "[]");
        if (!Array.isArray(notes)) notes = [];
        state.notes = notes;
      } catch { state.notes = []; }
    }
    function saveNotes() {
      localStorage.setItem(MOOD_KEY, JSON.stringify(state.notes));
    }
    // Simulate global board: for demo, "public" notes are saved locally and rotated in the board
    function getPublicNotes() {
      // Return only notes with public flag
      return state.notes.filter(n=>n.public).slice(-20).reverse();
    }
    // ---- UI Rendering ----
    const $ = sel => document.querySelector(sel);

    function renderMoodboard() {
      let publicNotes = getPublicNotes();
      let board = `
        <section class="moodboard" style="margin-top:11px;">
          <div class="note-form-modal">
            <textarea id="newNote" maxlength="160" placeholder="Type a calm thought, inspiration, or note‚Ä¶ (any language, emoji)"></textarea>
            <div class="note-action-row">
              <label class="toggle-public">
                <input type="checkbox" id="publicToggle"${state.isPublic?' checked':''}/>Public
                <span class="material-icons" style="font-size:1.06em;vertical-align:middle;">public</span>
              </label>
              <button class="note-btn" id="addNote">Share</button>
            </div>
          </div>
          <div style="font-size:1.00em;margin-bottom:7px;color:#beb693;">
            <span class="material-icons" style="font-size:1.11em;vertical-align:middle;color:var(--accent);">dashboard</span>
            Recent world thoughts:
          </div>
          <div class="note-board-grid">
            ${publicNotes.length?publicNotes.map(n=>
              `<div class="note-tile">
                  ${n.text.replace(/</g,'&lt;')}
                  <div class="note-public-mark material-icons" title="public note">public</div>
                  <div class="lang">${n.language||''}</div>
              </div>`
            ).join(''):
            `<div style="padding:13px;color:#b9a469;opacity:.6;">No public notes yet. Add the first inspiration for the world.</div>`
            }
          </div>
        </section>`;
      $('#main').innerHTML = board;
      $('#addNote').onclick = addNote;
      $('#publicToggle').onchange = e => { state.isPublic = e.target.checked; };
      $('#newNote').addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey) {addNote();e.preventDefault();}});
    }

    function addNote() {
      let noteInput = $('#newNote');
      let txt = noteInput.value.trim();
      if(!txt) return;
      let language = txt.match(/[^\x00-\x7F]/) ? 'üåè' : '';
      state.notes.push({text:txt,dt:Date.now(),public:state.isPublic,language});
      if(state.notes.length>100) state.notes=state.notes.slice(-80);
      saveNotes();
      noteInput.value="";
      renderMoodboard();
    }
    // ---- Page Routing & Nav ----
    function goPage(page){
      state.page=page;
      document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.toggle('active',b.dataset.page===page));
      if(page==='moodboard') renderMoodboard();
      if(page==='room') renderFocusRoom();
    }
    document.querySelectorAll('.bottom-nav button').forEach(b=>b.onclick=()=>goPage(b.dataset.page));
    document.getElementById('roomBtn').onclick = ()=>goPage('room');

    // ---- Focus Room (WebRTC demo, PeerJS cloud server used for quick test) ----
    let peer = null, myID="", connections=[], localStream=null;
    let focusUsers = {};

    async function renderFocusRoom() {
      let roomHTML = `
        <div class="focus-room">
          <div class="focus-header">
            <span><span class="material-icons" style="font-size:1.2em;vertical-align:middle;">video_camera_front</span> Silent Focus Room (video required, all muted)</span>
            <div class="music-bar">
              <span class="material-icons" style="font-size:1.11em;vertical-align:middle;color:var(--accent);">music_note</span>
              <select id="musicSel">${AMBIENT_TRACKS.map((t,i)=>`<option value="${i}"${i===currentTrack?' selected':''}>${t.name}</option>`).join('')}</select>
              <button id="pauseMusic" title="Pause/Play ambient">${ambient.paused?'‚ñ∂':'‚ùô‚ùô'}</button>
            </div>
          </div>
          <div class="zen-bg-jp" style="width:99%;height:90px;margin:6px auto 19px auto;"></div>
          <div style="font-size:0.98em;color:#9da188;margin-bottom:8px;">
            All video, all silent. Focus vibes only. Raise hand to share a note.
          </div>
          <div class="video-grid" id="videoGrid">
            <div style="color:#b1b1a1;font-size:1em;" id="videoMsg">Connecting you to Zen focus room‚Ä¶</div>
          </div>
          <button class="note-btn" id="raiseHandBtn" style="margin:8px auto 0 auto;">
            <span class="material-icons" style="font-size:1.09em;vertical-align:middle;">pan_tool</span>
            Raise hand & post a mood note
          </button>
        </div>
      `;
      $('#main').innerHTML = roomHTML;

      $("#musicSel").onchange=(e)=>{ playAmbient(+e.target.value); }
      $("#pauseMusic").onclick=()=>{
        if(ambient.paused) { ambient.play(); $("#pauseMusic").innerText='‚ùô‚ùô'; }
        else { ambient.pause(); $("#pauseMusic").innerText='‚ñ∂'; }
      };

      $("#raiseHandBtn").onclick = ()=>{
        showRaiseHand();
      };

      await bootFocusRoom();
    }

    // ------ VIDEO ROOM VIA PEERJS CLOUD ------
    async function bootFocusRoom() {
      if(localStream) { showVideo(); return; }
      // Request Camera
      let videoMsg = document.getElementById('videoMsg');
      if(!navigator.mediaDevices) {
        videoMsg.innerText="Browser not supported.";
        return;
      }
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      } catch {
        videoMsg.innerText="Camera required to join the Focus Room.";
        return;
      }
      // PeerJS cloud room (random but stable room name)
      if(!peer) peer = new Peer(undefined,{
        host:"peerjs.com",
        secure:true,
        port:443
      });
      peer.on('open',id=>{
        myID = id;
        focusUsers[id] = true;
        joinPeerRoom();
      });
      peer.on('call',call=>{
        call.answer(localStream);
        call.on('stream', remoteStream=>{
          addRemoteVideo(call.peer,remoteStream);
        });
      });
      peer.on('connection',conn=>{
        conn.on('open',()=>connections.push(conn));
      });
      // No room logic, fast peer-mesh: call all existing seen IDs
      window.peer=peer;
    }
    function joinPeerRoom() {
      // For demo, collect all room IDs in url hash for new connections
      setTimeout(()=>{
        document.getElementById('videoMsg').innerText="You are live in the Focus Room!";
        showVideo();
        // Simulate mesh call by polling every 5s for new peers
        setInterval(()=>{
          if(!peer) return;
          // In real: use server to share IDs; here crude url hash
          let ids=(location.hash||"").replace('#','').split(',').filter(String);
          if(!ids.includes(myID)) ids.push(myID);
          location.hash = ids.join(',');
          ids.filter(id=>id!==myID && !focusUsers[id])
             .forEach(id=>{
                let call = peer.call(id,localStream);
                focusUsers[id]=true;
                call.on('stream',stream=>addRemoteVideo(id,stream));
             });
       },5200);
      },600);
    }
    function showVideo() {
      const grid = $('#videoGrid');
      grid.innerHTML = '';
      // Local video
      if(localStream) {
        let v = document.createElement('video');
        v.autoplay=true;v.muted=true;v.playsInline=true;
        v.srcObject=localStream; v.style.width='94%';
        let tile = document.createElement('div');
        tile.className='video-tile';
        tile.appendChild(v);
        tile.innerHTML+='<div class="me-badge">You</div>';
        tile.innerHTML+='<div class="video-name">Focus</div>';
        grid.appendChild(tile);
      }
      // Other peers in room (demo: show how tiles work)
      // For a real global room use a simple signaling server, e.g. Firebase or small static relay.
    }
    function addRemoteVideo(peerId,stream) {
      if(document.getElementById("vid_"+peerId)) return;
      let grid = $('#videoGrid');
      let v = document.createElement('video');
      v.autoplay=true; v.playsInline=true; v.srcObject=stream; v.style.width='94%';
      let tile = document.createElement('div');
      tile.className='video-tile'; tile.id="vid_"+peerId;
      tile.appendChild(v);
      tile.innerHTML+='<div class="video-name">Focus</div>';
      grid.appendChild(tile);
    }

    // ------------- RAISE HAND/NON-INTRUSIVE NOTE SHARING -----------
    function showRaiseHand() {
      let note = prompt("Share a brief mood/thought to the room (shown to all screens):");
      if(note&&note.trim()) {
        // For now, add to public notes.
        state.notes.push({text:note.trim(),dt:Date.now(),public:true,language:''});
        saveNotes();
        alert("Your shared mood was posted to the world moodboard.");
      }
    }

    // -------- INITIAL BOOT -------
    loadNotes();
    goPage('moodboard');
    playAmbient(0);
  </script>
</body>
</html>
